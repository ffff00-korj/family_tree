<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивное семейное древо</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            padding: 20px;
            margin: 0;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .node {
            cursor: pointer;
            fill: lightblue;
            stroke: steelblue;
            stroke-width: 2px;
        }

        .node:hover {
            fill: lightgreen;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        .form {
            display: none;
            position: absolute;
            padding: 20px;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            width: 300px;
            z-index: 10;
        }

        .form h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: #444;
        }

        .form input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form button {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            border: none;
            background-color: #4CAF50;
            color: white;
            font-size: 1em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .form button:hover {
            background-color: #45a049;
        }

        .delete-button {
            margin-top: 10px;
            background-color: red;
            color: white;
            padding: 10px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .delete-button:hover {
            background-color: darkred;
        }

        .node-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #ccc;
        }

        .node-card {
            display: inline-block;
            width: 150px;
            text-align: center;
            padding: 15px;
            margin: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .node-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .node-card .name {
            font-weight: bold;
            color: #333;
            margin-top: 10px;
            font-size: 1em;
        }

        .node-card .date {
            color: #777;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .node-card .photo {
            margin-bottom: 10px;
        }

        svg {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <h1>Интерактивное семейное древо</h1>
    <svg width="800" height="600"></svg>

    <div class="form" id="form">
        <h3>Редактировать информацию</h3>
        <label for="name">Имя:</label>
        <input type="text" id="name" name="name">
        <label for="photo">Фото (URL):</label>
        <input type="text" id="photo" name="photo">
        <label for="birthDate">Дата рождения:</label>
        <input type="date" id="birthDate" name="birthDate">
        <label for="deathDate">Дата смерти:</label>
        <input type="date" id="deathDate" name="deathDate">
        <button id="saveButton">Сохранить</button>
        <button id="cancelButton">Отмена</button>
        <button id="deleteButton" class="delete-button">Удалить узел</button>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const width = 800, height = 600;
        const svg = d3.select("svg");
        const form = document.getElementById("form");
        const nameInput = document.getElementById("name");
        const photoInput = document.getElementById("photo");
        const birthDateInput = document.getElementById("birthDate");
        const deathDateInput = document.getElementById("deathDate");
        const saveButton = document.getElementById("saveButton");
        const cancelButton = document.getElementById("cancelButton");
        const deleteButton = document.getElementById("deleteButton");

        let root;

        async function loadTreeData() {
            try {
                const response = await fetch('http://localhost:5000/api/tree');
                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }
                const treeData = await response.json();
                renderTree(treeData);
            } catch (error) {
                console.error('Ошибка запроса на сервер:', error);
            }
        }

        function renderTree(treeData) {
            root = d3.hierarchy(treeData);
            const treeLayout = d3.tree().size([width - 100, height - 100]);
            const links = treeLayout(root).links();

            svg.selectAll(".link")
                .data(links)
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal().x(d => d.x + 50).y(d => d.y + 50));

            const nodes = svg.selectAll(".node")
                .data(root.descendants())
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x + 50}, ${d.y + 50})`)
                .on("click", (event, d) => {
                    nameInput.value = d.data.name;
                    photoInput.value = d.data.photo || "";
                    birthDateInput.value = d.data.birthDate || "";
                    deathDateInput.value = d.data.deathDate || "";
                    form.style.display = "block";
                    form.style.left = `${event.pageX + 10}px`;
                    form.style.top = `${event.pageY + 10}px`;
                    form.dataset.nodeId = d.id;
                    form.dataset.nodeData = JSON.stringify(d.data);
                });

            nodes.append("circle")
                .attr("r", 20)
                .attr("class", "node")
                .style("fill", "lightblue")
                .style("stroke", "steelblue")
                .style("stroke-width", 2);

            nodes.append("image")
                .attr("x", -20)
                .attr("y", -20)
                .attr("width", 40)
                .attr("height", 40)
                .attr("xlink:href", d => d.data.photo || "https://via.placeholder.com/40");

            nodes.append("text")
                .attr("dy", -30)
                .attr("text-anchor", "middle")
                .text(d => d.data.name);
        }

        saveButton.addEventListener("click", saveNodeData);
        deleteButton.addEventListener("click", deleteNodeData);

        async function saveNodeData() {
            const nodeId = form.dataset.nodeId;
            const node = root.descendants().find(d => d.id === nodeId);
            if (node) {
                node.data.name = nameInput.value;
                node.data.photo = photoInput.value;
                node.data.birthDate = birthDateInput.value;
                node.data.deathDate = deathDateInput.value;

                console.log("Обновленные данные для отправки:", node.data);  // Логируем данные перед отправкой

                try {
                    await updateBackend(node.data, 'update');
                    loadTreeData();  // Загружаем обновленное дерево
                    form.style.display = "none";
                } catch (error) {
                    console.error("Ошибка при сохранении данных:", error);
                }
            }
        }

        async function deleteNodeData() {
            const nodeId = form.dataset.nodeId;
            const nodeData = JSON.parse(form.dataset.nodeData);
            const parentNode = findParent(root, nodeData);

            if (parentNode) {
                const childIndex = parentNode.children.findIndex(child => child.id === nodeData.id);
                if (childIndex !== -1) {
                    parentNode.children.splice(childIndex, 1);
                }
            }

            console.log("Данные для удаления:", nodeData);  // Логируем данные перед удалением

            try {
                await updateBackend(nodeData, 'delete');
                loadTreeData();  // Загружаем обновленное дерево
                form.style.display = "none";
            } catch (error) {
                console.error("Ошибка при удалении данных:", error);
            }
        }

        async function updateBackend(nodeData, action) {
            const url = action === 'update' ? 'http://localhost:5000/api/tree/update' : 'http://localhost:5000/api/tree/delete';
            const method = action === 'update' ? 'POST' : 'DELETE';
            const body = action === 'update' ? JSON.stringify({nodeData}) : JSON.stringify({id: nodeData.id});

            console.log(`Отправка ${action} запроса на сервер...`, {url, method, body});

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: body
                });

                if (!response.ok) {
                    throw new Error('Ошибка запроса');
                }
                console.log(`${action} запрос успешно выполнен`);
            } catch (error) {
                console.error(`${action} запрос не удался:`, error);
            }
        }

        loadTreeData();  // Загружаем дерево с бека при старте
    </script>
</body>

</html>
